var MyRecipeBoxes = angular.module("MyRecipeBoxes", ["firebase"]);

MyRecipeBoxes.run(['angularFireAuth',function(angularFireAuth)
{
	var url = "https://myrecipeboxes.firebaseio.com/";
	angularFireAuth.initialize(url,{'name':'user','path':'/'});
}]);

MyRecipeBoxes.constant("FIREBASE_URL","https://myrecipeboxes.firebaseio.com/");


/* **********************************************
     Begin routes.js
********************************************** */

MyRecipeBoxes.config(function($routeProvider)
{

	$routeProvider
	.when("/",{
		templateUrl: 'views/home.html',
		controller: "User",
		authRequired: false
	})
	.when("/login",{
		templateUrl: 'views/login.html',
		controller: "User",
		authRequired: false
	})
	.when("/boxes",{
		templateUrl: 'views/boxes/list.html',
		controller: "Boxes",
		authRequired: false
	})
	.when("/box/:user_id/:box_id",{
		templateUrl: 'views/boxes/box.html',
		controller: "Box",
		authRequired: false
	})
	.when("/recipe/:recipe_id",{
		templateUrl: 'views/recipes/get.html',
		controller: 'Recipe',
		authRequired: true
	})
	.when("/recipe/:recipe_id/edit",{
		templateUrl: 'views/recipes/create.html',
		controller: 'Recipe',
		authRequired: true
	})
	.when("/recipe/create/:user_id/:box_id/",{
		templateUrl: 'views/recipes/create.html',
		controller: 'Recipes',
		authRequired: true
	});
});

/* **********************************************
     Begin partials.js
********************************************** */

MyRecipeBoxes.directive("createbox",function()
{
	return {
		restrict: "E",
		templateUrl: "views/boxes/create.html"
	};
});


/* **********************************************
     Begin services.js
********************************************** */

MyRecipeBoxes.factory("firebaseCollection",["$rootScope","$q","angularFireCollection",function($rootScope,$q,angularFireCollection)
{
	var collections = {};


	var Collection = function(url){

		var data = angularFireCollection(url);

		data.findByIds = function(ids)
		{
			var objs = [];
			for(var i=0,len = data.length; i<len; i++)
			{
				if(ids.indexOf(data[i].$id) > -1)
				{
					objs.push(data[i]);
				}
			}
			return objs;
		};

		data.getByKey  = function(key, value)
		{
			for(var i=0, len=data.length; i<len; i++)
			{
				if(data[i][key] === value)
				{
					return data[i];
				}
			}

			return false;
		}

		return data;

	};
	// put any publicly accessable methods or values inside
	return function(url,callback)
	{
		if(!collections[url])
		{
			collections[url] = new Collection(url);
		}
		if(callback)
		{
			var deferred = $q.defer();
			var interval = setInterval(function(){
				$rootScope.$apply(
					function() {
					if(collections[url].length > 0)
					{
						deferred.resolve(collections[url]);
						clearInterval(interval);
					}
				});
			},100);

			deferred.promise.then(function(data)
			{
				callback(data);
			});
		}

		return collections[url];
	};
}]);

/* **********************************************
     Begin UserController.js
********************************************** */

MyRecipeBoxes.controller("User",['$scope','$location','angularFireCollection','angularFireAuth',function($scope,$location,angularFireCollection,angularFireAuth)
{


	$scope.login = function()
	{
		// pass the user
		angularFireAuth.login("password",$scope.user).then(function()
		{
			$location.path("/boxes");
		});
	};

	$scope.logout = function()
	{
		angularFireAuth.logout();
	};

	$scope.create_user = function()
	{
		// create the user
		angularFireAuth.createUser($scope.user.email,$scope.user.password,function(user){
			if(user)
			{
				$location.path("/boxes");
			}
		});
	};

	// validate that the password and confirm password match
	$scope.validatePassword = function()
	{
		// set the not matching error if the passwords don't match
		$scope.signup.confirm.$error.notMatching = $scope.user.password !== $scope.user.confirm;
	};

	$scope.$on("angularFireAuth:error", function(evt, err) {
		console.log('err',err);
	});
}]);

/* **********************************************
     Begin BoxesController.js
********************************************** */

MyRecipeBoxes.controller("Boxes",['FIREBASE_URL','$scope','firebaseCollection',function(FIREBASE_URL,$scope,firebaseCollection)
{

	$scope.boxes = firebaseCollection(FIREBASE_URL+"boxes");
	$scope.create_box = function()
	{
		$scope.boxes.add({
			title: $scope.newbox.title,
			privacy: $scope.newbox.privacy,
			user_id: $scope.user.id,
			recipes: []
		});
		$scope.newbox = {};
	};

	$scope.log = function()
	{
		console.log('$scope.createbox.title',$scope.createbox.title);
	};
}]);

/* **********************************************
     Begin BoxController.js
********************************************** */

MyRecipeBoxes.controller("Box",['FIREBASE_URL','$scope','firebaseCollection','$routeParams',function(FIREBASE_URL,$scope,firebaseCollection,$routeParams)
{



	firebaseCollection(FIREBASE_URL+"boxes",function(boxes)
	{
		$scope.box = boxes.getByName($routeParams.box_id);
		if ($scope.box.recipes)
		{
			firebaseCollection(FIREBASE_URL+"recipes",function(recipes)
			{
				$scope.recipes = recipes.getByNames($scope.box.recipes);
			});
		}
		else
		{
			$scope.recipes = [];
		}
	});




}]);

/* **********************************************
     Begin RecipesController.js
********************************************** */

MyRecipeBoxes.controller("Recipes",['FIREBASE_URL','$scope','$location','firebaseCollection','$routeParams',function(FIREBASE_URL,$scope,$location,firebaseCollection,$routeParams)
{
	$scope.sizes = ["Measurment","Cup(s)","Tbsp(s)","Tsp(s)","Oz(s)","None"];
	$scope.open = false;
	$scope.recipe = {};
	$scope.recipe.ingredients = [{}];

	$scope.recipes = firebaseCollection(FIREBASE_URL+"recipes");

	$scope.add_ingred = function()
	{
		$scope.recipe.ingredients.push({});
	};
	$scope.create_recipe = function()
	{
		$scope.recipe.user_id = $routeParams.user_id;
		var id = $scope.recipes.add(angular.copy($scope.recipe)).name();

		firebaseCollection(FIREBASE_URL+"boxes",function(boxes)
		{
			var box = boxes.getByName($routeParams.box_id);

			if(!box.recipes)
			{
				box.recipes = [];
			}
			box.recipes.push(id);

			boxes.update(box);
			$location.path("/box/"+$routeParams.user_id+"/"+$routeParams.box_id);
		});

	};

}]);

/* **********************************************
     Begin RecipeContoller.js
********************************************** */

MyRecipeBoxes.controller("Recipe",['$scope','$routeParams','FIREBASE_URL','firebaseCollection',function($scope, $routeParams, FIREBASE_URL, firebaseCollection){

	firebaseCollection(FIREBASE_URL+"recipes", function(recipes)
	{
		$scope.recipe = recipes.getByName($routeParams.recipe_id);
		console.log('$scope.recipe',$scope.recipe);
	});
}]);
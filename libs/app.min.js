var MyRecipeBoxes = angular.module("MyRecipeBoxes", ["firebase",function($locationProvider)
{
	//$locationProvider.html5Mode(true).hashPrefix('!');

}]);

MyRecipeBoxes.run(['angularFireAuth',function(angularFireAuth)
{
	var url = "https://myrecipeboxes.firebaseio.com/";
	angularFireAuth.initialize(url,{'name':'user','path':'/'});
}]);


/* **********************************************
     Begin routes.js
********************************************** */

MyRecipeBoxes.config(function($routeProvider)
{

	$routeProvider
	.when("/",{
		templateUrl: 'views/home.html',
		controller: "SignUp",
		authRequired: false
	})
	.when("/login",{
		templateUrl: 'views/login.html',
		controller: "User",
		authRequired: false
	})
	.when("/boxes",{
		templateUrl: 'views/boxes/list.html',
		controller: "Boxes",
		authRequired: false
	})
	.when("/box/:user_id/:recipe_id",{
		templateUrl: 'views/boxes/box.html',
		controller: "Box",
		authRequired: false
	});
});

/* **********************************************
     Begin partials.js
********************************************** */

MyRecipeBoxes.directive("createbox",function()
{
	return {
		restrict: "E",
		templateUrl: "views/boxes/create.html"
	};
});

/* **********************************************
     Begin UserController.js
********************************************** */

MyRecipeBoxes.controller("User",['$scope','$location','angularFireCollection','angularFireAuth',function($scope,$location,angularFireCollection,angularFireAuth)
{

	$scope.log_user = function()
	{
		angularFireAuth.login("password",{'email':$scope.user.email,'password':$scope.user.password});
	}
	$scope.logout = function()
	{
		angularFireAuth.logout();
	}


	$scope.$on("angularFireAuth:login", function(evt, user) {
	  	$location.path("/boxes");
	});
	$scope.$on("angularFireAuth:logout", function(evt, user) {
	  	$location.path("/");
	});

	$scope.$on("angularFireAuth:error", function(evt, err) {
	  console.log('err',err);
	});

}]);

/* **********************************************
     Begin SignUpController.js
********************************************** */

MyRecipeBoxes.controller("SignUp",['$scope','angularFireCollection','angularFireAuth',function($scope,angularFireCollection,angularFireAuth)
	{


		$scope.create_user = function()
		{
			angularFireAuth._authClient.createUser($scope.user.email,$scope.user.password,function(error,user)
			{
				if(!error)
				{
					angularFireAuth._loggedIn(user);

				}
				//TODO: ERROR HANDLING
			});
		};

		$scope.validatePassword = function()
		{
			$scope.signup.confirm.$error.dontMatch = $scope.user.password !== $scope.user.confirm;
		};
	}]);

/* **********************************************
     Begin BoxesController.js
********************************************** */

MyRecipeBoxes.controller("Boxes",['$scope','angularFireCollection',function($scope,angularFireCollection)
{

	var url = "https://myrecipeboxes.firebaseio.com/boxes" ;
	$scope.boxes = angularFireCollection(url);
	$scope.create_box = function()
	{
		$scope.boxes.add({title: $scope.newbox.title, privacy: $scope.newbox.privacy, user_id: $scope.user.id});
		$scope.newbox = {};
	};
}]);

/* **********************************************
     Begin BoxController.js
********************************************** */

MyRecipeBoxes.controller("Box",['$scope','angularFire','$routeParams',function($scope,angularFire,$routeParams)
{

	var url = "https://myrecipeboxes.firebaseio.com/boxes" ;

	console.log('$routeParams.recipe_id',$routeParams.recipe_id);
	angularFire(url+"/"+$routeParams.recipe_id,$scope,'box',{});

	console.log('$scope.box',$scope.box);

}]);
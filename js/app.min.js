// Application
var MyRecipeBoxes = angular.module("MyRecipeBoxes", ['ngRoute',"firebase","ui.bootstrap"]);

// Set the firebase URL for the app
MyRecipeBoxes.constant("FIREBASE_URL","https://myrecipeboxes.firebaseio.com/");

// function that runs on initial load.
MyRecipeBoxes.run([
	'$rootScope',
	'FIREBASE_URL',
	'$firebase',
	'$location',
	'$fireLogin',
	function($rootScope,FIREBASE_URL,$firebase,$location,$fireLogin)
	{

    // initialize AngularFire Authentication using custom $fireLogin factory
	$fireLogin.init(FIREBASE_URL,'/signup');

    // Listen for login event, from either session login or login form submission
    $rootScope.$on('$firebaseSimpleLogin:login',function(evt,user)
    {

        // set up the user info from firebase
		$rootScope.user_info = $firebase(new Firebase(FIREBASE_URL+"users/"+user.uid));

    });

    // on click of logout button
    $rootScope.logout = function()
    {

        // logout of firebase
        $fireLogin.$logout();

        // reset user info
        $rootScope.user_info = undefined;
        $rootScope.user = undefined;

        // go to login page
        $location.path('/login');
    };

    // when there is an error with firebase authentication
	$rootScope.$on("$firebaseSimpleLogin:error", function(evt, err) {

        //TODO: add error handling
		console.log('err',err);
	});

}]);





/* **********************************************
     Begin partials.js
********************************************** */

// Custom directive for the partial of the box creation
MyRecipeBoxes.directive("createbox",function()
{
	return {
		restrict: "E",
		templateUrl: "views/boxes/create.html"
	};
});


/* **********************************************
     Begin routes.js
********************************************** */

// All of the routes for the application
MyRecipeBoxes.config(['$routeProvider','$authProvider',function($routeProvider,$authProvider)
{

	// $authProvider checks for the user authenitcation before loading the route
	// authRequired is for if the user must be logged in to go to route

	$routeProvider

	// home page/list of all the recipe boxes
	.when("/",{
		templateUrl: 'views/boxes/list.html',
		controller: "Boxes",
		resolve: $authProvider.resolve,
		authRequired: true
	})

	// signup Page
	.when("/signup",{
		templateUrl: 'views/home.html',
		controller: "User",
		resolve: $authProvider.resolve,
		authRequired: false
	})

	// login Page
	.when("/login",{
		templateUrl: 'views/login.html',
		controller: "User",
		resolve: $authProvider.resolve,
		authRequired: false
	})

	// detail page of one box
	.when("/boxes/:box_id",{
		templateUrl: 'views/boxes/box.html',
		controller: "Recipes",
		resolve: $authProvider.resolve,
		authRequired: true
	})

	// create a new recipe
	.when("/boxes/:box_id/recipes/create",{
		templateUrl: 'views/recipes/create.html',
		controller: 'Recipes',
		resolve: $authProvider.resolve,
		authRequired: true
	})

	// detail page of recipe
	.when("/boxes/:box_id/recipes/:recipe_id",{
		templateUrl: 'views/recipes/get.html',
		controller: 'Recipes',
		resolve: $authProvider.resolve,
		authRequired: true
	})

	// edit/fork of a recipe
	.when("/boxes/:box_id/recipes/:recipe_id/:type",{
		templateUrl: 'views/recipes/create.html',
		controller: 'Recipes',
		resolve: $authProvider.resolve,
		authRequired: true
	});

}]);

/* **********************************************
     Begin filters.js
********************************************** */

/* global MyRecipeBoxes */

// toArray filter to allow filtering on objects.
// converts object to array
// key set as an key value pair with the key of $key
MyRecipeBoxes.filter('toArray', function () {
    'use strict';

    return function (obj) {
        if (!(obj instanceof Object)) {
            return obj;
        }
        return Object.keys(obj).filter(function(key){if(key.charAt(0) !== "$") {return key;}}).map(function (key) {
            return Object.defineProperty(obj[key], '$key', {value: key});
        });
    };
});

/* **********************************************
     Begin UserController.js
********************************************** */

// Controller for user information
MyRecipeBoxes.controller("User",[
	'$scope',
	'$location',
	'$firebase',
	'FIREBASE_URL',
	'$rootScope',
	'$fireLogin',
	function($scope,$location,$firebase,FIREBASE_URL,$rootScope,$fireLogin)
{

	// on login form submission
	$scope.login = function()
	{
		// login to firebase
		$fireLogin.$login('password',$scope.user_form).then(function()
		{
			// if successful redirect to home page
			$location.path('/');
		},function(error)
		{
			// if unsuccessful throw error
			//TODO: error handling
			console.log('error',error);
		});
	};


	// on signup form submission
	$scope.create_user = function()
	{
		// create the user in firebase
		$fireLogin.$createUser($scope.user_form.email,$scope.user_form.password).then(function(user)
		{
			console.log('user',user);
			if(user)
			{
				// setup user information in firebase
				$rootScope.user_info = $firebase(new Firebase(FIREBASE_URL+"users/"+user.uid));
				$rootScope.user_info.first_name = $scope.user_form.first_name;
				$rootScope.user_info.last_name = $scope.user_form.last_name;
				$rootScope.user_info.email = $scope.user_form.email;
				$rootScope.user_info.id = user.uid;
				$rootScope.user_info.$save();

				// redirect to home page
				$location.path("/");
			}
		},function(error)
		{
			// if unsuccessful throw error
			//TODO: error handling;
			console.log('error',error);
		});
	};

	// validate that the password and confirm password match
	$scope.validatePassword = function()
	{
		// set the not matching error if the passwords don't match
		$scope.signup.confirm.$error.notMatching = $scope.user_form.password !== $scope.user_form.confirm;
	};
}]);

/* **********************************************
     Begin RecipesController.js
********************************************** */

// Controller for One Box/Recipe
MyRecipeBoxes.controller("Recipes",[
	'FIREBASE_URL',
	'$scope',
	'$location',
	'$firebase',
	'$routeParams',
	'$rootScope',
	function(FIREBASE_URL,$scope,$location,$firebase,$routeParams,$rootScope)
	{
		// get the current box using the route
		$scope.box = $firebase(new Firebase(FIREBASE_URL+"boxes/"+$routeParams.box_id));

		// get all the boxes for the user
		$scope.boxes = $firebase(new Firebase(FIREBASE_URL+"boxes").startAt($rootScope.user.uid).endAt($rootScope.user.uid));

		// if we aren't forking the recipe
		if($routeParams.type !== "fork")
		{
			// set the box id to the route param
			$scope.box_$id = $routeParams.box_id;
		}
		// if we are looking at one recipe
		if($routeParams.recipe_id)
		{
			// get the child recipe of the box
			$scope.recipe = $scope.box.$child('recipes/'+$routeParams.recipe_id);

			// set the recipe id
			$scope.recipe_$id = $routeParams.recipe_id;
		}
		// if we are creating a new recipe
		else
		{
			// SETUP NG-MODEL
			$scope.recipe = {};
			$scope.recipe.ingredients = [{}];
		}

		// sizes for edit/create/fork dropdown
		$scope.sizes = ["Measurment","Cup(s)","Tbsp(s)","Tsp(s)","Oz(s)","None"];

		// DUMMY DATA
		// $scope.recipe.title = "My Recipe";
		// $scope.recipe.ingredients = [{size: "1",measurement:"Cup(s)",food:"flour"}];
		// $scope.recipe.preheat = "350";
		// $scope.recipe.directions = "Direction";

		// on recipe form submit
		$scope.save_recipe = function()
		{
			// if the box of the recipe has changed
			if($routeParams.box_id !== $scope.box_$id)
			{
				// if there is no box id stop
				if($scope.box_$id === undefined)
				{
					//TODO: throw error
					return;
				}
				// get the box to add the recipe to
				$scope.box = $firebase(new Firebase(FIREBASE_URL+"boxes/"+$scope.box_$id));

				// add the recipe to the box
				$scope.box.$child('recipes').$add($scope.recipe);
			}
			else
			{
				// if we are editing a recipe
				if(typeof $routeParams.recipe_id !== 'undefined')
				{

					// save it
					$scope.recipe.$save();

				}
				// if we are creating a recipe
				else{

					// set the user id to the current user
					$scope.recipe.user_id = $rootScope.user.uid;

					// add the recipe to the box
					$scope.box.$child('recipes').$add($scope.recipe);

				}
			}

			// go back to the box detail page
			$location.path("/boxes/"+$scope.box_$id);

		};

	}]);

/* **********************************************
     Begin BoxesController.js
********************************************** */

// Controller for the box listing page
MyRecipeBoxes.controller("Boxes",[
	'FIREBASE_URL',
	'$scope',
	'$firebase',
	'$rootScope',
	function(FIREBASE_URL,$scope,$firebase,$rootScope)
	{
		// the firebase for the boxes
		var boxes_ref = new Firebase(FIREBASE_URL+"boxes");

		// set up the box model
		$scope.newbox = {privacy: "public"};

		// on create box form submit
		$scope.create_box = function()
		{
			// add the box to the boxes
			$scope.boxes.$add({
				title: $scope.newbox.title,
				privacy: $scope.newbox.privacy,
				user_id: $rootScope.user.uid,
				$priority: $rootScope.user.uid,
				recipes: []
			});

			// reset the box model
			$scope.newbox = {privacy: "public"};

		};

		// on tab click
		$scope.switch_filter = function(type)
		{

			// if only viewing the user's boxes
			if(type === 'user' && $rootScope.user)
			{
				// set up the info for the view
				$scope.my_boxes = true;
				$scope.box_filter = "";

				// get boxes with the priority of the current user
				$scope.boxes = $firebase(boxes_ref.startAt($rootScope.user.uid).endAt($rootScope.user.uid));

			}
			// if looking at all the public boxes
			else if(type === 'public' && $rootScope.user)
			{
				// set up the info for the view
				$scope.my_boxes = false;
				$scope.box_filter = {privacy:"public"};

				// get all the boxes
				$scope.boxes = $firebase(boxes_ref);

			}

		};

		// initialize with the user boxes

		$scope.switch_filter('user');

	}]);